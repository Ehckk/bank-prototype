<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Account</title>
</head>
<body>
    <form method="get" id="login" name="login-form">
        <p id="message"></p>
        <div class="field">
            <label for="username">Username</label>
            <input type="text" name="username" id="username"/>
        </div>
        <div class="field">
            <label for="username">Password</label>
            <input type="password" name="password" id="password"/>
        </div>
        <div class="buttons">
            <button type="submit">Log In</button>
        </div>
    </form>    
</body>
<script type="module">
    import data from './scripts/data.js'
    import auth from './scripts/auth.js'
    import form from './scripts/form.js'

    const loginSelector = "#login"
    const loginSubmit = await form.submit({
        selector: loginSelector,
        validate: async (values) => {
            const {username, password} = values
            const user = await data.fetchOne({
                name: "users",
                predicate: user => {
                    return user.username === username
                }
            })
            console.log(user)
            if (!user) {
                throw new Error(`No user with username '${username}'!`)
            }
            if (user.password !== password) {
                throw new Error("Passwords do not match!")
            }
            return user
        },
        onSuccess: (user) => auth.login(user)
    })
    console.log(loginSubmit)
    const loginForm = document.querySelector(loginSelector)  
    loginForm.addEventListener("submit", loginSubmit)
</script>
</html>